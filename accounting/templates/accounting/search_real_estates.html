{% extends "starter-template.html" %}

{% block page_style %}
    <link rel="stylesheet" href="http://fk.github.io/select2-bootstrap-css/css/bootstrap.min.css">
    <!-- <link rel="stylesheet" href="http://select2.github.io/select2/select2-3.5.2/select2.css"> -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/css/select2.min.css">
    <link rel="stylesheet" href="http://fk.github.io/select2-bootstrap-css/css/select2-bootstrap.css">
{% endblock %}

{% block page_content %}

<form class="form-horizontal" role="form">
  <div class="form-group">
    <label for="inputPassword3" class="col-sm-2 control-label">Адрес</label>
    <div class="col-sm-10 select2-wrapper">
        <select class="js-example-data-ajax form-control" name="XXX">
        {% if real_estate %}
            <option value="{{real_estate.id}}" selected="selected">{{real_estate.real_estate_str}}</option>
        {% endif %}
        </select>
    </div>
  </div>
  <div class="form-group">
    <div class="col-sm-offset-2 col-sm-10">
      <button type="submit" class="btn btn-default">Найти</button>
    </div>
  </div>
</form>

{% if accounts %}
    <h2>Cчёт</h2>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Период</th>
                <th>Баланс</th>
                <th>Операции</th>
                <th>Действие</th>
            </tr>
        </thead>
        <tbody>
        {% for account in accounts %}
            <tr>
                <td>#{{ account.period.id }} с {{ account.period.start }} по {{ account.period.end }}</td>
                <td>{{ account.balance }}</td>
                <td>
                {% for operation in account.operations %}
                    <span style="{% if operation.operation_type == operation.WRITE_OFF %}color: red; {% else %}color: green; {% endif %}white-space:nowrap;">{{operation.amount }} {{ operation.operation_date }}</span><br>
                {% endfor %}
                </td>
                <td><a href="{% url 'accounting:report' %}?period={{ account.period.id }}&real_estate={{ real_estate.id }}">платёжный документ</a></td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>Поиск результатов не дал.</p>
{% endif %}

{% endblock %}

{% block page_script %}
<!-- <script src="//select2.github.io/select2/select2-3.4.2/select2.js"></script> -->
<script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/js/select2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/js/i18n/ru.js"></script>


<script>
    //https://select2.github.io/announcements-4.0.html
var $ajax = $(".js-example-data-ajax");
  $ajax.select2({
    ajax: {
      url: "/real_estates/options/",
      dataType: 'json',
      delay: 250,
      data: function (params) {
        return {
          q: params.term, // search term
          page: params.page
        };
      },
      processResults: function (data, params) {
        // parse the results into the format expected by Select2
        // since we are using custom formatting functions we do not need to
        // alter the remote JSON data, except to indicate that infinite
        // scrolling can be used
        params.page = params.page || 1;

        return {
          results: data.items,
          pagination: {
            more: (params.page * 30) < data.total_count
          }
        };
      },
      cache: true
    },
    escapeMarkup: function (markup) { return markup; },
    minimumInputLength: 3
  });
</script>
{% endblock %}